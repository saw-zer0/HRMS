<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance</title>
    <link rel="stylesheet" href="attendance.css">
    <script src="https://kit.fontawesome.com/b99e675b6e.js"></script>
</head>
<body>

<div class="wrapper">
  <div class="sidebar">
    <h2><img src="/LOGO.png" class="logo"></h2>
    <ul>
      <li class="home"><a href="#" class="nav-item">Home</a></li>
      <li class="profile"><a href="#" class="nav-item">Profile</a></li>
      <li class="attendance"><a href="#" class="nav-item">Attendance</a></li>
      <li class="leave"><a href="#" class="nav-item">Leave</a></li>
      <li class="payroll"><a href="#" class="nav-item">Payroll</a></li>
    </ul>
    <div class="social_media">
    </div>
  </div>
  <div class="main_content">
    <div class="header">
      <div class="notification">
        <button class="notify-btn"><i class="fas fa-bell"></i></button>
      </div>
      <div class="profile">
        <button class="profile-button" onclick=""> <i class="fas fa-user"></i><span>AnupThapa</span></button>
      </div>
      <div class="popup" id="popup">
        <span class="popup-content">
          
          <span class="close" id="close">&times;</span>
           <div class="image-container">
            <img src="profile.png" alt="Image" class="popup-image">
           </div> 
           <span class="edit-profile">
            <a href="#" id="edit-profile-link">Edit Profile</a>
          </span>
          <p class="name">Anup Thapa</p>
          <p>Email: anup@example.com</p>
          <p>Address: kamalpokhari</p>
          <p>Phone number: 98000000</p>
          <label for="user-id">Enter Your ID:</label>
          <input type="text" id="user-id" name="user-id" required>
          <button id="validateUserIdBtn">Validate</button>
          
          
        
        </span>
      </div>
      <button class="log-out">Logout</button>
    </div>

    <div class="attendance-content">
        <div class="attendance-header">
          <h2>Attendance</h2>
          <div class="attendance-record">
            <h3>Attendance Record for Current Month</h3>
            <div class="record-boxes">
              <div class="box">
                <h4>Absent Days</h4>
                <p>5</p>
              </div>
              <div class="box">
                <h4>Present Days</h4>
                <p>25</p>
              </div>
              <div class="box">
                <h4>Overtime Days</h4>
                <p>3</p>
              </div>
            </div>
          </div>
        </div>
        <div class="clock-buttons">
          <button class="clock-in-btn" id="clock-in-button">Clock In</button>
          <button class="clock-out-btn" id="clock-out-button">Clock Out</button>
        </div>
        
        <div class="time-sheet">
          <h3>Attendance Time Sheet</h3>
          <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Clock In Time</th>
                    <th>Clock Out Time</th>
                    <th>Apply for Correction</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>2024-04-01</td>
                    <td>08:00 AM</td>
                    <td>05:00 PM</td>
                    <td><button class="apply-correction-btn">Apply</button></td>
                </tr>
            
            </tbody>
        </table>
        </div>
      </div>
      <div class="correction-popup" id="correction-popup">
        <span class="popup-content">
          <span class="close" id="close-correction">&times;</span>
          <h3>Apply Correction</h3>
          <form id="correction-form">
            <label for="employee-name">Employee Name:</label>
            <input type="text" id="employee-name" name="employee-name" required><br><br>
            
            <label for="date">Date:</label>
            <input type="text" id="date" name="date" required><br><br>
            
            <label for="reason">Reason:</label>
            <textarea id="reason" name="reason" required></textarea><br><br>
            
            <div class="button-container">
              <button type="button" id="cancel-correction">Cancel</button>
              <button type="submit">Submit</button>
            </div>
          </form>
        </span>
      </div>

      
      <script>
        //profile popup
       
          document.addEventListener("DOMContentLoaded", function() {
    const profileButton = document.querySelector(".profile-button");
    const popup = document.querySelector(".popup");
    const closePopup = document.querySelector(".close");
    const validateBtn = document.getElementById("validateUserIdBtn");
    const userIdInput = document.getElementById("user-id");
    const clockInBtn = document.getElementById("clock-in-button");
    const clockOutBtn = document.getElementById("clock-out-button");

    profileButton.addEventListener("click", function() {
        popup.style.display = "block";
    });

    closePopup.addEventListener("click", function() {
        popup.style.display = "none";
    });

    validateBtn.addEventListener("click", async () => {
    const userId = userIdInput.value.trim();

    if (!userId) {
        alert("Please enter a valid user ID.");
        return;
    }

    try {
        const response = await fetch(`/validate-user/${userId}`);
        const data = await response.json();

        if (data.message === "Correct user. Please clock in.") {
            alert(data.message);
            clockInBtn.disabled = false; 
            clockOutBtn.disabled = false; 
        } else {
            alert("Invalid user ID. Please try again.");
            clockInBtn.disabled = true; 
            clockOutBtn.disabled = true; 
        }
    } catch (error) {
        console.error("Error validating user:", error);
        alert("An error occurred while validating the user ID.");
    }
});

clockInBtn.addEventListener("click", async () => {
    try {
        const response = await fetch("/clock-in", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ userId: userIdInput.value.trim() }) // Send the user ID for clock-in
        });
        if (!response.ok) {
            throw new Error("Failed to clock in");
        }
        alert("Clock-in successful");
    } catch (error) {
        console.error("Error:", error.message);
        alert("Failed to clock in. Please try again.");
    }
});

clockOutBtn.addEventListener("click", async () => {
    try {
        const response = await fetch("/clock-out", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ userId: userIdInput.value.trim() }) // Send the user ID for clock-out
        });
        if (!response.ok) {
            throw new Error("Failed to clock out");
        }
        alert("Clock-out successful");
    } catch (error) {
        console.error("Error:", error.message);
        alert("Failed to clock out. Please try again.");
    }
});

});


//fetch clock-in data from databse
fetch("/attendance")
  .then(response => response.json())
  .then(data => {
    const tableBody = document.querySelector(".time-sheet table tbody");

    data.forEach(entry => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${entry.date}</td>
        <td>${entry.clock_in}</td>
        <td>${entry.clock_out}</td>
        <td><button class="apply-correction-btn">Apply</button></td>
      `;
      tableBody.appendChild(row);

      const applyCorrectionButton = row.querySelector(".apply-correction-btn");
      const correctionPopup = document.getElementById("correction-popup");

      applyCorrectionButton.addEventListener("click", function() {
        const date = entry.date;
        document.getElementById("date").value = date;
        correctionPopup.style.display = "block";
      });
    });
  })
  .catch(error => console.error("Error fetching attendance data:", error));

document.getElementById("close-correction").addEventListener("click", function() {
  document.getElementById("correction-popup").style.display = "none";
});

document.getElementById("cancel-correction").addEventListener("click", function() {
  document.getElementById("correction-popup").style.display = "none";
});

document.getElementById("correction-form").addEventListener("submit", function(event) {
  event.preventDefault();
  const employeeName = document.getElementById("employee-name").value;
  const date = document.getElementById("date").value;
  const reason = document.getElementById("reason").value;

  document.getElementById("correction-popup").style.display = "none";
});


      </script>
      
</body>
</html>
