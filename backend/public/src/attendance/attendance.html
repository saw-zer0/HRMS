<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance</title>
    <link
            rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        />
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
        <script src="https://kit.fontawesome.com/b99e675b6e.js"></script>
    <link rel="stylesheet" href="src/attendance/attendance.css">
    <script src="../../src/script.js" defer></script>
</head>
<body>

<div class="wrapper">
  <div class="sidebar">
    <h2><img src="/LOGO.png" class="logo"></h2>
    <ul>
      <li class="home"><a href="#" class="nav-item" onclick="navigateToPage('./')">Home</a></li>
      <li class="profile"><a href="#" class="nav-item" onclick="navigateToPage('profile')">Profile</a></li>
      <li class="attendence"><a href="#" class="nav-item" onclick="navigateToPage('attendance')">Attendance</a></li>
      <li class="leave"><a href="#" class="nav-item" onclick="navigateToPage('/leave')">Leave</a></li>
      <li class="payroll"><a href="#" class="nav-item" onclick="navigateToPage('payroll')">Payroll</a></li>
    </ul>
    <div class="social_media">
    </div>
  </div>
  <div class="main_content">
    <div class="header">
      <div class="notification">
        <button class="notify-btn"><i class="fas fa-bell"></i></button>
      </div>
      <div class="profile">
        <button class="profile-button" onclick=""> <i class="fas fa-user"></i><span>AnupThapa</span></button>
      </div>
      <div class="popup" id="popup">
        <span class="popup-content">
          
          <span class="close" id="close">&times;</span>
           <div class="image-container">
            <img src="profile.png" alt="Image" class="popup-image">
           </div> 
           <span class="edit-profile">
            <a href="#" id="edit-profile-link">Edit Profile</a>
          </span>
          <p class="name">Anup Thapa</p>
          <p>Email: anup@example.com</p>
          <p>Address: kamalpokhari</p>
          <p>Phone number: 98000000</p>
        
        </span>
      </div>
      <button class="log-out" onclick="logout()">Logout</button>
    </div>

    <div class="attendance-content">
        <div class="attendance-header">
          <h2>Attendance</h2>
          <div class="attendance-record">
            
            <h3>Attendance Record for Current Month</h3>
            <div class="record-boxes">
              <div class="box">
                <h4>Missed</h4>
                <p>5</p>
              </div>
              <div class="box">
                <h4>Pending Requests</h4>
                <p>0</p>
              </div>
              <div class="box">
                <h4>Approved Requests</h4>
                <p>0</p>
              </div>
              <div class="box">
                <h4>Rejected Requests</h4>
                <p>0</p>
              </div>
            </div>
          </div>
        </div>
        <div class="clock-buttons">
          <button class="clock-in-btn" id="clock-in-button">Clock In</button>
          <button class="clock-out-btn" id="clock-out-button">Clock Out</button>
        </div>
        <div class="view-requests">
          <button id="view-requests-btn">View requests</button>
      </div>
        <div class="time-sheet">
          <h3>Attendance Time Sheet</h3>
          <table class="attendanceTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Clock In Time</th>
                    <th>Clock Out Time</th>
                    <th>Apply for Correction</th>
                </tr>
            </thead>
            <tbody>
            
            </tbody>
        </table>
        <br>
          <h3>Attendance Request History</h3>
          <table class="historyTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Clock In Time</th>
                    <th>Clock Out Time</th>
                    <th>Remarks</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            
            </tbody>
        </table>
        </div>
      </div>
      <div
          class="requests-container"
          id="requests-container"
          style="display: none"
      >
          <span class="close-btn" id="close-requests">&times;</span>
          <table class="requests-table">
              <thead>
                  <tr>
                      <th>Employee Name</th>
                      <th>Status</th>
                      <th>Date</th>
                      <th>New Clock In</th>
                      <th>Clock In</th>
                      <th>New Clock Out</th>
                      <th>Clock Out</th>
                      <th>Remark</th>
                  </tr>
              </thead>
              <tbody></tbody>
          </table>
      </div>
      <div class="correction-popup" id="correction-popup">
        <span class="popup-content">
          <span class="close" id="close-correction">&times;</span>
          <h3>Apply Correction</h3>
          <form id="correction-form">
            <div class="form-group">
              <label for="clockin">Clock in at:</label>
              <input
                  type="time"
                  id="clockinField"
                  name="clockinField"
                  required
              />
          </div>
            <div class="form-group">
              <label for="clockout">Clock out at:</label>
              <input
                  type="time"
                  id="clockoutField"
                  name="clockoutField"
                  required
              />
            
              <div class="form-group">
                <label for="remark"
                    >Remarks:</label
                ><br />
                <textarea
                    id="remarks"
                    name="remarks"
                    rows="4"
                    cols="50"
                    required
                ></textarea>
            </div>
              <div class="form-group">
                <label for="team"
                    >Team:</label
                ><br />
                <select id="team-dropdown" class="form-select" aria-label="Default select example">
                  <option selected value="">Open this select menu</option>
                  
                  
                </select>
            </div>
            <div class="button-container">
              <button type="button" id="cancel-correction">Cancel</button>
              <button type="submit">Submit</button>
            </div>
          </form>
        </span>
      </div>
      
      
  <script>
    //profile popup
    let editAttId = null;
    function navigateToPage(page) {
    window.location.href = page;
  }
    document.addEventListener("DOMContentLoaded", function() {
      var profileButton = document.querySelector(".profile-button");
      var popup = document.querySelector(".popup");
      var closePopup = document.querySelector(".close");
      
      profileButton.addEventListener("click", function() {
        popup.style.display = "block";
      });
      
      closePopup.addEventListener("click", function() {
        popup.style.display = "none";
      });
    });

    function openApplyCorrectionPopup(id) {
      const getAttendanceRecord = async (id) => {
        try {
          const response = await fetch(`api/attendance/${id}`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json"
            }
          });
          if (!response.ok) {
            throw new Error("Failed to fetch attendance record");
          }
          const teamResponse = await fetch("api/team/members/verify", {
            method: "GET",
            headers: {
              "Content-Type": "application/json"
            }
          });
          if (!teamResponse.ok) {
            throw new Error("Failed to fetch team data");
          }
          const teamData = await teamResponse.json();
          const teamDropdown = document.getElementById("team-dropdown");
          teamData.forEach((team) => {
            const option = document.createElement("option");
            option.value = team.team_id;
            option.text = team.name;
            teamDropdown.appendChild(option);
          });
          const data = await response.json();
          console.log(data);
          // Process the attendance record data here
        } catch (error) {
          console.error("Error:", error.message);
        }
      };

      getAttendanceRecord(id);
      editAttId = id;
      document.getElementById("correction-popup").style.display = "block";
    }
    //apply correction popup
    document.addEventListener("DOMContentLoaded", function() {
      var applyCorrectionButtons = document.querySelectorAll(".apply-correction-btn");
      var correctionPopup = document.getElementById("correction-popup");
      var closeCorrection = document.getElementById("close-correction");
      var cancelCorrection = document.getElementById("cancel-correction");
      
      
      applyCorrectionButtons.forEach(function(button) {
        button.addEventListener("click", function() {
          
          var date = this.parentNode.parentNode.firstElementChild.innerText;
          document.getElementById("date").value = date;
          
          correctionPopup.style.display = "block";
        });
      });
      
      
      closeCorrection.addEventListener("click", function() {
        correctionPopup.style.display = "none";
      });
      
      
      cancelCorrection.addEventListener("click", function() {
        correctionPopup.style.display = "none";
      });
      
      
      document.getElementById("correction-form").addEventListener("submit", async function(event) {
        event.preventDefault(); 
        
        var clockinValue = document.getElementById("clockinField").value;
        var clockoutValue = document.getElementById("clockoutField").value;
        var remarksValue = document.getElementById("remarks").value;
        var teamValue = document.getElementById("team-dropdown").value;
        //post data to the server
        try {
          const response = await fetch("api/attendance/requests", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              att_id: editAttId,
              clock_in: clockinValue,
              clock_out: clockoutValue,
              remark: remarksValue,
              att_id: editAttId,
              team: teamValue
            })
          });
          if (!response.ok) {
            throw new Error("Failed to post data to the server");
          }
          alert("Correction request submitted successfully");
          correctionPopup.style.display = "none";
          getAttendanceRequest();
          // Process the response here
        } catch (error) {
          console.error("Error:", error.message);
        }

      });
    });
    
    
    //clock in and clock out
    $(document).ready(function(){
        const getTodayClockIn = async () => {
          try {
            const response = await fetch("api/attendance/clock-in-today", {
              method: "GET",
              headers: {
                "Content-Type": "application/json"
              }
            });
            if (!response.ok) {
              throw new Error("Failed to fetch today's clock in");
            }
            const data = await response.json();
            console.log(data)
            if (data.length > 0) {
              document.getElementById("clock-in-button").disabled = true;
              document.getElementById("clock-out-button").disabled = false;

            } else {
              document.getElementById("clock-in-button").disabled = false;
              document.getElementById("clock-out-button").disabled = true;
            }
          } catch (error) {
            console.error("Error:", error.message);
          }
        };

      getTodayClockIn();
      const displayAttendance = (attendance) => {
        //display attendance data in a table
        const table = document.querySelector(".attendanceTable tbody");
        attendance.forEach((attendance) => {
            const row = table.insertRow();
            row.innerHTML = `
                <td>${attendance.date}</td>
                <td>${attendance.clock_in}</td>
                <td>${attendance.clock_out}</td>
                <td><button data-attid=${attendance.attendance_id} class="apply-correction-btn" onclick="openApplyCorrectionPopup(this.dataset.attid)">Apply</button></td>
            `;
        });
      }
      const getAttendance = async () => {
        try {
            const response = await fetch("api/attendance/user", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            });
            if (!response.ok) {
                throw new Error("Failed to fetch attendance data");
            }
            const data = await response.json();
            displayAttendance(data);
        } catch (error) {
            console.error("Error:", error.message);
        }
    };
    getAttendance();
    const postClockIn = async () => {
      try {
          const response = await fetch("api/attendance/clock-in", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json"
              },
              body: JSON.stringify({})  
          });
          if (!response.ok) {
              throw new Error("Failed to clock in");
          }
          console.log("Clock-in successful");
        } catch (error) {
            console.error("Error:", error.message);
        }
      };
      $("#clock-in-button").click(function(){
        postClockIn();
        document.querySelector("table tbody").innerHTML = "";
        getAttendance();
        document.getElementById("clock-out-button").disabled = false;
      });
    const postClockOut = async () => {
      try {
          const response = await fetch("api/attendance/clock-out", {
              method: "PUT",
              headers: {
                  "Content-Type": "application/json"
              },
              body: JSON.stringify({})  
          });
          if (!response.ok) {
              throw new Error("Failed to clock out");
          }
          console.log("Clock-out successful");
      } catch (error) {
          console.error("Error:", error.message);
      }
    };
    $("#clock-out-button").click(function(){
      postClockOut();
      //clear table
      document.querySelector("table tbody").innerHTML = "";
      getAttendance();
    });

      const displayAttendanceRequest = (attendance) => {
        //display attendance data in a table
        const table = document.querySelector(".historyTable tbody");
        attendance.forEach((attendance) => {
            const row = table.insertRow();
            row.innerHTML = `
                <td>${attendance.date}</td>
                <td>${attendance.clock_in}</td>
                <td>${attendance.clock_out}</td>
                <td>${attendance.remark}</td>
                <td>${attendance.status}</td>
                ${attendance.status === "PENDING" ? `<td><button data-attid=${attendance.attendance_id} class="apply-correction-btn" onclick="openApplyCorrectionPopup(this.dataset.attid)">Apply</button></td>` : "" }
                
            `;
        });
      }
      const getAttendanceRequest = async () => {
        try {
            const response = await fetch("api/attendance/requests/user", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            });
            if (!response.ok) {
                throw new Error("Failed to fetch attendance request data");
            }
            const data = await response.json();
            displayAttendanceRequest(data);
        } catch (error) {
            console.error("Error:", error.message);
        }
    };
    getAttendanceRequest();
    
    });

    var viewRequestsBtn =
        document.getElementById("view-requests-btn")
    var closeRequestsBtn = document.getElementById("close-requests")
    var requestsContainer =
        document.getElementById("requests-container")

    viewRequestsBtn.addEventListener("click", function () {
        if (requestsContainer.style.display === "none") {
            requestsContainer.style.display = "block"
        } else {
            requestsContainer.style.display = "none"
        }
    })

    closeRequestsBtn.addEventListener("click", function () {
        // Hide the requests container when close button is clicked
        requestsContainer.style.display = "none"
    })

    //fetch requests
    const displayRequests = (requests) => {
      //display attendance data in a table
      const table = document.querySelector(".requests-table tbody");
      requests.forEach((request) => {
          const row = table.insertRow();
          row.innerHTML = `
              <td>${request.full_name}</td>
              <td>${request.status}</td>
              <td>${request.date}</td>
              <td>${request.clock_in}</td>
              <td>${request.old_clockin}</td>
              <td>${request.clock_out}</td>
              <td>${request.old_clockout}</td>
              <td>${request.remark}</td>
          `;
          var approveButton =
                                    document.createElement("button")
                                approveButton.textContent = "Approve"
                                approveButton.classList.add("approve-btn")
                                approveButton.addEventListener(
                                    "click",
                                    function () {
                                        fetch(
                                            `/api/attendance/requests/${request.att_req_id}/approve_verify`,
                                            {
                                                method: "PUT",
                                                headers: {
                                                    "Content-Type":
                                                        "application/json",
                                                },
                                                body: JSON.stringify({
                                                    status: "Approved",
                                                }),
                                            }
                                        )
                                            .then((response) => response.json())
                                            .then((data) => {
                                                document.querySelector(
                                                    `#att${id} .status`
                                                ).innerHTML = "Rejected"
                                                console.log(data)
                                            })
                                            .catch((error) => {
                                                console.error(error)
                                            })
                                    }
                                )
                                row.appendChild(approveButton)

                                var rejectButton =
                                    document.createElement("button")
                                rejectButton.textContent = "Reject"
                                rejectButton.classList.add("reject-btn")
                                rejectButton.addEventListener(
                                    "click",
                                    function () {
                                        fetch(
                                            `/api/attendance/requests/${request.att_req_id}/reject_verify`,
                                            {
                                                method: "PUT",
                                                headers: {
                                                    "Content-Type":
                                                        "application/json",
                                                },
                                                body: JSON.stringify({
                                                    status: "Rejected",
                                                }),
                                            }
                                        )
                                            .then((response) => response.json())
                                            .then((data) => {
                                                console.log(data)
                                            })
                                            .catch((error) => {
                                                console.error(error)
                                            })
                                    }
                                )
                                row.appendChild(rejectButton)
      });
    }



    const getRequests = async () => {
      try {
          const response = await fetch("api/attendance/requests/teams", {
              method: "GET",
              headers: {
                  "Content-Type": "application/json"
              }
          });
          if (!response.ok) {
              throw new Error("Failed to fetch attendance request data");
          }
          const data = await response.json();
          console.log(data)
          displayRequests(data);
      } catch (error) {
          console.error("Error:", error.message);
      }
  };
  getRequests();

  function getMissedCount() {
    fetch("api/attendance/user/missed", {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    })
    .then(response => response.json())
    .then(data => {
      console.log(data);
      document.querySelector(".box:nth-child(1) p").innerText = data.count;
    })
    .catch(error => {
      console.error("Error:", error.message);
    });
  }
  getMissedCount();

  function getRequestCounts() {
    fetch("api/attendance/requests/user/counts", {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    })
    .then(response => response.json())
    .then(data => {
      console.log(data);
      data.forEach((item) => {
        if (item.status === "PENDING") {
          document.querySelector(".box:nth-child(2) p").innerText = item.count;
        } else if (item.status === "APPROVED") {
          document.querySelector(".box:nth-child(3) p").innerText = item.count;
        } else if (item.status === "REJECTED") {
          document.querySelector(".box:nth-child(4) p").innerText = item.count;
        }
      });
      
    })
    .catch(error => {
      console.error("Error:", error.message);
    });
  }
  getRequestCounts();
  </script>
</body>
</html>
